{% extends 'base.html' %}
{% load static %}

{% block title %}RealHome - Home{% endblock %}

{% block content %}
<script src="/static/JS/map.js"></script>

<div class="property-details">
    <div class="property-images">
        <img src="{{ property.image.url }}" alt="Property Image" class="main-image">
        <div class="image-thumbnails">
            <img src="{{ property.image.url }}" alt="Thumbnail 1">
            <img src="{{ property.image.url }}" alt="Thumbnail 2">
            <img src="{{ property.image.url }}" alt="Thumbnail 3">
        </div>
    </div>

    <div class="property-info">
        <h1 class="property-price">R{{ property.price|floatformat:0 }}</h1>
        {% if user.is_authenticated %}
            <button 
                class="favorite-button {% if is_favorited %}favorited{% endif %}"
                onclick="toggleFavorite({{property.id}})"
                aria-label="Add to favorites">
                <span class="heart-icon">{% if is_favorited %}❤️{% else %}🤍{% endif %}</span>
            </button>
            {% endif %}
        <p class="property-address">{{ property.address }}, {{ property.city }}, {{ property.state }} {{ property.zip_code }}</p>

        <div class="property-stats">
            <span class="stat">{{ property.bedrooms }} beds</span>
            <span class="stat">{{ property.bathrooms }} baths</span>
            <span class="stat">{{ property.square_meters }} sqft</span>
        </div>

        <div class="estimated-payment">
            <p>Est. payment: R{{ estimated_payment|floatformat:0 }}/mo</p>
            <a href="#" class="get-pre-qualified">Get pre-qualified</a>
        </div>

        <div class="property-details">
            <div class="detail-item">
                <span class="detail-icon">🏠</span>
                <span class="detail-label">{{ property.property_type }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-icon">🏗️</span>
                <span class="detail-label">Built in {{ property.year_built }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-icon">📏</span>
                <span class="detail-label">{{ property.lot_size }} sqmt lot</span>
            </div>
        </div>
    </div>
</div>

<!-- Contact Agent Modal -->
<div id="contactModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeContactModal()">&times;</span>
        <h2>Contact Agent</h2>
        <form id="contactForm" method="POST" action="{% url 'realtors:contact' %}">
            {% csrf_token %}
            <input type="hidden" name="property_id" value="{{ property.id }}">
            
            <div class="form-group">
                <label for="name">Your Name</label>
                <input type="text" id="name" name="name" required {% if user.is_authenticated %}value="{{ user.get_full_name }}"{% endif %}>
            </div>
            
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" required {% if user.is_authenticated %}value="{{ user.email }}"{% endif %}>
            </div>
            
            <div class="form-group">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" name="phone" required {% if user.is_authenticated %}value="{{ user.phone }}"{% endif %}>
            </div>
            
            <div class="form-group">
                <label for="message">Message</label>
                <textarea id="message" name="message" required>I am interested in {{ property.address }}.</textarea>
            </div>
            
            <button type="submit" class="submit-button">Send Message</button>
        </form>
    </div>
</div>
<div class="map">
<div id="map">
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA5YDEZWkQng9YLQRl4eLvldFRMlW9qZ8k&callback=initMap" async defer></script>
</div>
</div>
<script>
    
    function toggleFavorite(propertyId) {
        fetch(`/property/${propertyId}/favorite/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            const button = document.querySelector('.favorite-button');
            const heartIcon = button.querySelector('.heart-icon');
            
            if (data.status === 'added') {
                button.classList.add('favorited');
                heartIcon.textContent = '❤️';
                showMessage('Added to favorites', 'success');
            } else {
                button.classList.remove('favorited');
                heartIcon.textContent = '🤍';
                showMessage('Removed from favorites', 'success');
            }
        })
        .catch(error => {
            showMessage('Error updating favorites', 'error');
        });
    }

    function openContactModal() {
        document.getElementById('contactModal').style.display = 'block';
    }

    function closeContactModal() {
        document.getElementById('contactModal').style.display = 'none';
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
        const modal = document.getElementById('contactModal');
        if (event.target == modal) {
            closeContactModal();
        }
    }

    // Form submission handling
    document.getElementById('contactForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const form = this;
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('Message sent successfully!', 'success');
                closeContactModal();
            } else {
                showMessage(data.message || 'Error sending message.', 'error');
            }
        })
        .catch(error => {
            showMessage('Error sending message.', 'error');
        });
    });

    function showMessage(message, type) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `alert alert-${type}`;
        messageDiv.textContent = message;
        
        document.querySelector('.property-detail').insertAdjacentElement('beforebegin', messageDiv);
        
        setTimeout(() => {
            messageDiv.remove();
        }, 5000);
    }
</script>
{% endblock %}